<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SHBET ‚Äî Nh√≥m l·∫°m d·ª•ng</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .glass{background:rgba(255,255,255,.92);backdrop-filter:blur(8px)}
    .soft-shadow{box-shadow:0 10px 25px rgba(0,0,0,.08)}
  </style>
</head>
<body class="min-h-screen bg-slate-50">
  <main class="w-full px-4 md:px-8 py-10">
    <div class="mx-auto w-full max-w-screen-lg space-y-10">

      <!-- üö® NH√ìM L·∫†M D·ª§NG: FORM -->
      <section class="glass soft-shadow rounded-2xl p-6 md:p-8 w-full">
        <h1 class="text-3xl font-extrabold text-center mb-6" style="color:#00A3C6;">B·ªò PH·∫¨N R·ª¶I RO SHBET</h1>
        <h2 class="text-xl font-extrabold text-slate-800 flex items-center gap-2">üö® Nh√≥m l·∫°m d·ª•ng</h2>

        <div class="mt-6 grid grid-cols-1 gap-4">
          <label class="text-sm font-semibold" for="abuseTaiKhoan">T√™n t√†i kho·∫£n</label>
          <input id="abuseTaiKhoan" type="text" class="w-full border rounded-lg p-3" placeholder="Nh·∫≠p t√™n t√†i kho·∫£n" />

          <label class="text-sm font-semibold mt-2" for="abuseNoiDung">N·ªôi dung / h√¨nh th·ª©c l·∫°m d·ª•ng</label>
          <textarea id="abuseNoiDung" rows="4" class="w-full border rounded-lg p-3" placeholder="M√¥ t·∫£ chi ti·∫øt"></textarea>

          <label class="text-sm font-semibold mt-2" for="abuseTroChoi">Tr√≤ ch∆°i l·∫°m d·ª•ng</label>
          <select id="abuseTroChoi" class="w-full border rounded-lg p-3">
            <option value="">-- Ch·ªçn --</option>
            <option>Casino</option>
            <option>Slot</option>
            <option>Th·ªÉ Thao</option>
            <option>Game b√†i 3D</option>
            <option>X·ªï s·ªë</option>
            <option>Tham gia b·∫•t th∆∞·ªùng, ƒëƒÉng nh·∫≠p b·∫•t th∆∞·ªùng</option>
            <option>Th√¥ng tin ·∫£o, kh√¥ng ch√≠nh ch·ªß</option>
          </select>

          <label class="text-sm font-semibold mt-2" for="abuseNhanVien">Nh√¢n vi√™n</label>
          <input id="abuseNhanVien" type="text" class="w-full border rounded-lg p-3" placeholder="Nh·∫≠p t√™n nh√¢n vi√™n" />

          <label class="text-sm font-semibold mt-2" for="abuseXuLy">X·ª≠ l√Ω</label>
          <select id="abuseXuLy" class="w-full border rounded-lg p-3">
            <option value="">-- Ch·ªçn tr·∫°ng th√°i --</option>
            <option>C·∫ßn theo d√µi th√™m</option>
            <option>ƒê√£ x·ª≠ l√Ω v√† h·ªó tr·ª£ tham gia theo d√µi th√™m</option>
            <option>ƒê√≥ng t√†i kho·∫£n</option>
            <option>ƒêang ƒë·ª£i xin √≠ ki·∫øn c·∫•p tr√™n</option>
          </select>

          <label class="text-sm font-semibold mt-2" for="abuseFile">Ch·ªçn file (·∫¢nh/Excel)</label>
          <input id="abuseFile" type="file" class="w-full border rounded-lg p-3"
                 accept=".png,.jpg,.jpeg,.webp,.pdf,.xlsx,.xls,.csv" />
          <div id="abuseFilePreview" class="mt-2"></div>
        </div>

        <button id="btnAbuseUpload" onclick="submitAbuse()"
                class="mt-6 inline-flex items-center gap-2 bg-rose-600 text-white font-semibold rounded-lg px-5 py-3 hover:bg-rose-700">
          üì§ Upload
        </button>
      </section>

      <!-- üîé T√åM KI·∫æM L·∫†M D·ª§NG -->
      <section class="glass soft-shadow rounded-2xl p-6 md:p-8 w-full">
        <h2 class="text-xl font-extrabold text-slate-800 flex items-center gap-2">üîé T√¨m ki·∫øm D·ªØ li·ªáu (L·∫°m d·ª•ng)</h2>

        <div class="mt-6 grid grid-cols-1 gap-4">
          <label class="text-sm font-semibold" for="sAbuseTK">T√¨m theo T√™n t√†i kho·∫£n</label>
          <input id="sAbuseTK" type="text" class="w-full border rounded-lg p-3" placeholder="Nh·∫≠p t·ª´ kh√≥a" />

          <label class="text-sm font-semibold" for="sAbuseND">T√¨m theo N·ªôi dung</label>
          <input id="sAbuseND" type="text" class="w-full border rounded-lg p-3" placeholder="Nh·∫≠p t·ª´ kh√≥a n·ªôi dung" />

          <label class="text-sm font-semibold" for="sAbuseXL">T√¨m theo Tr·∫°ng th√°i x·ª≠ l√Ω</label>
          <select id="sAbuseXL" class="w-full border rounded-lg p-3">
            <option value="--all--">-- T·∫•t c·∫£ --</option>
            <option value="C·∫ßn theo d√µi th√™m">C·∫ßn theo d√µi th√™m</option>
            <option value="ƒê√£ x·ª≠ l√Ω v√† h·ªó tr·ª£ tham gia theo d√µi th√™m">ƒê√£ x·ª≠ l√Ω v√† h·ªó tr·ª£ tham gia theo d√µi th√™m</option>
            <option value="ƒê√≥ng t√†i kho·∫£n">ƒê√≥ng t√†i kho·∫£n</option>
            <option value="ƒêang ƒë·ª£i xin √≠ ki·∫øn c·∫•p tr√™n">ƒêang ƒë·ª£i xin √≠ ki·∫øn c·∫•p tr√™n</option>
          </select>
        </div>

        <button onclick="searchAbuse()" class="mt-6 inline-flex items-center gap-2 bg-sky-600 text-white font-semibold rounded-lg px-5 py-3 hover:bg-sky-700">
          üîç T√¨m ki·∫øm
        </button>

        <div id="abuseResults" class="mt-6 text-sm text-slate-700"></div>
      </section>

    </div>
  </main>

<script>
/* ==== B·∫ÆT BU·ªòC: ƒê·ªîI URL N√ÄY TH√ÄNH WEB APP URL C·ª¶A B·∫†N ==== */
const WEB_APP_URL = "PASTE_YOUR_WEB_APP_URL_HERE";

/* ===== Helpers ===== */
function parseDriveId(url){const m=String(url||'').match(/\/file\/d\/([^/]+)\//);if(m&&m[1])return m[1];const m2=String(url||'').match(/[?&]id=([^&]+)/);return m2?m2[1]:''}
function toDriveViewUrl(url){const id=parseDriveId(url);return id?`https://drive.google.com/uc?export=view&id=${id}`:url}
function isImageByExt(name=''){return /\.(png|jpe?g|webp|gif|bmp|svg)$/i.test(name)}
function escapeHTML(s){return String(s??'').replace(/[&<>\"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]))}
function formatTimeVN(iso){if(!iso)return '‚Äî';const d=new Date(iso);if(isNaN(d))return escapeHTML(String(iso));return new Intl.DateTimeFormat('vi-VN',{timeZone:'Asia/Ho_Chi_Minh',day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit',hour12:false}).format(d)}
function renderAttachmentCell({fileUrl,fileName,mimeType}){if(!fileUrl&&!fileName)return'<span class="text-slate-400">‚Äî</span>';const viewUrl=toDriveViewUrl(fileUrl||'');const isImg=viewUrl?.startsWith('http')&&((mimeType||'').startsWith('image/')||isImageByExt(fileName||''));if(isImg){return `<div class="flex items-center gap-3"><a href="${fileUrl||viewUrl}" target="_blank"><img src="${viewUrl}" class="h-12 w-12 object-cover rounded border" /></a><a href="${fileUrl||viewUrl}" target="_blank" class="text-sky-700 hover:underline truncate max-w-[220px]">${escapeHTML(fileName||'·∫¢nh ƒë√≠nh k√®m')}</a></div>`}const name=escapeHTML(fileName||'T·ªáp ƒë√≠nh k√®m');return `<a href="${fileUrl||viewUrl}" target="_blank" class="inline-flex items-center gap-2 px-2 py-1 rounded bg-slate-100 border text-slate-700">üìé <span class="truncate max-w-[240px]">${name}</span></a>`}

/* ===== Preview file ===== */
document.getElementById('abuseFile').addEventListener('change', e=>{
  const f=e.target.files?.[0], box=document.getElementById('abuseFilePreview'); if(!f){box.innerHTML='';return;}
  const isImg=f.type.startsWith('image/')||isImageByExt(f.name); const size=(f.size/1024).toFixed(1)+' KB';
  if(isImg){const url=URL.createObjectURL(f); box.innerHTML=`<div class="flex items-center gap-3 p-3 bg-slate-50 rounded-lg border">
      <img src="${url}" class="h-16 w-16 object-cover rounded"/>
      <div class="min-w-0"><div class="font-medium truncate">${escapeHTML(f.name)}</div>
      <div class="text-xs text-slate-500">${escapeHTML(f.type||'image')}, ${size}</div></div></div>`}
  else{box.innerHTML=`<div class="flex items-center gap-3 p-3 bg-slate-50 rounded-lg border">
      <div class="h-10 w-10 bg-slate-200 rounded flex items-center justify-center">üìé</div>
      <div class="min-w-0"><div class="font-medium truncate">${escapeHTML(f.name)}</div>
      <div class="text-xs text-slate-500">${escapeHTML(f.type||'file')}, ${size}</div></div></div>`}
});

/* ===== Upload abuse ===== */
async function submitAbuse(){
  const taiKhoan=document.getElementById('abuseTaiKhoan').value.trim();
  const noiDung =document.getElementById('abuseNoiDung').value.trim();
  const troChoi =document.getElementById('abuseTroChoi').value;
  const nhanVien=document.getElementById('abuseNhanVien').value.trim();
  const xuLy    =document.getElementById('abuseXuLy').value;
  const file    =document.getElementById('abuseFile').files[0];

  if(!taiKhoan || !noiDung || !nhanVien || !xuLy){
    alert('‚ö†Ô∏è Vui l√≤ng nh·∫≠p ƒë·ªß: T√†i kho·∫£n, N·ªôi dung, Nh√¢n vi√™n, X·ª≠ l√Ω.'); return;
  }

  let fileName="", mimeType="", base64="", fileSize=0;
  if(file){
    fileName=file.name; mimeType=file.type||''; fileSize=file.size||0;
    const reader=new FileReader();
    base64=await new Promise(rs=>{ reader.onload=e=>rs(String(e.target.result).split(',')[1]); reader.readAsDataURL(file); });
  }

  const btn=document.getElementById('btnAbuseUpload'); btn.disabled=true; btn.textContent='ƒêang g·ª≠i...';
  try{
    const res=await fetch(WEB_APP_URL,{
      method:'POST',
      // KH√îNG ƒë·∫∑t Content-Type ƒë·ªÉ tr√°nh preflight c·ªßa Apps Script
      body: JSON.stringify({
        dataset:'abuse', // üëà quan tr·ªçng: ghi v√†o sheet "Abuse"
        taiKhoan, noiDung, troChoi, nhanVien, xuLy,
        fileName, mimeType, base64, fileSize,
        timeSent: new Date().toISOString()
      })
    });
    const json=await res.json();
    if(!res.ok || !json.ok) throw new Error(json.error || ('HTTP '+res.status));
    alert('‚úÖ ƒê√£ l∆∞u b√°o c√°o l·∫°m d·ª•ng!');
    // clear
    ['abuseTaiKhoan','abuseNoiDung','abuseNhanVien'].forEach(id=>document.getElementById(id).value='');
    document.getElementById('abuseTroChoi').value='';
    document.getElementById('abuseXuLy').value='';
    document.getElementById('abuseFile').value='';
    document.getElementById('abuseFilePreview').innerHTML='';
  }catch(err){
    console.error(err); alert('‚ùå L·ªói khi l∆∞u: '+err.message);
  }finally{
    btn.disabled=false; btn.textContent='üì§ Upload';
  }
}

/* ===== Search abuse ===== */
async function searchAbuse(){
  const kwTK =document.getElementById('sAbuseTK').value.trim().toLowerCase();
  const kwND =document.getElementById('sAbuseND').value.trim().toLowerCase();
  const pick =document.getElementById('sAbuseXL').value;

  const box=document.getElementById('abuseResults');
  box.innerHTML="<p class='text-slate-500'>ƒêang t·∫£i d·ªØ li·ªáu...</p>";

  try{
    const res =await fetch(WEB_APP_URL+'?dataset=abuse&action=list',{method:'GET',cache:'no-store'});
    const json=await res.json();
    if(!res.ok || !json.ok) throw new Error(json.error || ('HTTP '+res.status));

    const rows=Array.isArray(json.rows)?json.rows:[];
    const filtered=rows.filter(r=>{
      const tk=String(r.taiKhoan||'').toLowerCase();
      const nd=String(r.noiDung ||'').toLowerCase();
      const xl=String(r.xuLy    ||'');
      const passTK=!kwTK || tk.includes(kwTK);
      const passND=!kwND || nd.includes(kwND);
      const passXL=(pick==='--all--'||pick===''||xl===pick);
      return passTK && passND && passXL;
    });

    if(!filtered.length){
      box.innerHTML="<p class='text-red-600'>‚ùå Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu ph√π h·ª£p</p>";
      return;
    }

    const htmlRows = filtered.map(r=>{
      const taiKhoan = escapeHTML(r.taiKhoan||'');
      const noiDung  = escapeHTML(r.noiDung ||'');
      const troChoi  = escapeHTML(r.troChoi ||'');
      const nhanVien = escapeHTML(r.nhanVien||'');
      const xuLy     = escapeHTML(r.xuLy    ||'');

      const fileUrl  = r.thumbUrl || r.viewURL || r.fileUrl || r.fileURL || '';
      const fileName = r.fileName || '';
      const mimeType = r.mimeType || r.mimetype || '';
      const attach   = renderAttachmentCell({fileUrl,fileName,mimeType});

      const timeCell = formatTimeVN(r.timeSent || r.timestamp || '');
      return `
        <tr class="border-b align-top">
          <td class="px-3 py-2">${taiKhoan}</td>
          <td class="px-3 py-2">${noiDung}</td>
          <td class="px-3 py-2">${troChoi}</td>
          <td class="px-3 py-2">${nhanVien}</td>
          <td class="px-3 py-2">${xuLy}</td>
          <td class="px-3 py-2">${attach}</td>
          <td class="px-3 py-2 whitespace-nowrap">${timeCell}</td>
        </tr>`;
    }).join('');

    box.innerHTML = `
      <div class="overflow-auto rounded-lg border">
        <table class="min-w-full text-left text-sm">
          <thead class="bg-slate-100 text-slate-700">
            <tr>
              <th class="px-3 py-2">T√†i kho·∫£n</th>
              <th class="px-3 py-2">N·ªôi dung</th>
              <th class="px-3 py-2">Tr√≤ ch∆°i</th>
              <th class="px-3 py-2">Nh√¢n vi√™n</th>
              <th class="px-3 py-2">X·ª≠ l√Ω</th>
              <th class="px-3 py-2">T·ªáp ƒë√≠nh k√®m</th>
              <th class="px-3 py-2">Th·ªùi gian</th>
            </tr>
          </thead>
          <tbody>${htmlRows}</tbody>
        </table>
      </div>`;
  }catch(err){
    console.error(err); alert('‚ùå L·ªói t·∫£i d·ªØ li·ªáu: '+err.message); box.innerHTML='';
  }
}
</script>
</body>
</html>
