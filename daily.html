<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Nh·∫≠p & T√¨m ki·∫øm d·ªØ li·ªáu ƒê·∫°i l√Ω</title>
  <!-- TailwindCSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Hai class nh·ªè cho n·ªÅn k√≠nh & ƒë·ªï b√≥ng */
    .glass{background:rgba(255,255,255,.92);backdrop-filter:blur(8px)}
    .soft-shadow{box-shadow:0 10px 25px rgba(0,0,0,.08)}
  </style>
</head>
<body class="min-h-screen bg-slate-50">
  <main class="w-full px-4 md:px-8 py-10">
    <div class="mx-auto w-full max-w-screen-lg space-y-10">

      <!-- 1) NH·∫¨P D·ªÆ LI·ªÜU ƒê·∫†I L√ù -->
      <section class="glass soft-shadow rounded-2xl p-6 md:p-8 w-full">
        <h2 class="text-xl font-extrabold text-slate-800 flex items-center gap-2">
          üìå Nh·∫≠p d·ªØ li·ªáu ƒê·∫°i l√Ω
        </h2>

        <div class="mt-6 grid grid-cols-1 gap-4">
          <label class="text-sm font-semibold" for="daily">ƒê·∫°i l√Ω</label>
          <input id="daily" type="text" class="w-full border rounded-lg p-3" placeholder="Nh·∫≠p t√™n ƒë·∫°i l√Ω" />

          <label class="text-sm font-semibold mt-3" for="noiDung">N·ªôi dung</label>
          <textarea id="noiDung" rows="4" class="w-full border rounded-lg p-3" placeholder="Nh·∫≠p n·ªôi dung"></textarea>

          <label class="text-sm font-semibold mt-3" for="employee">Nh√¢n vi√™n</label>
          <input id="employee" type="text" class="w-full border rounded-lg p-3" placeholder="Nh·∫≠p t√™n nh√¢n vi√™n" />

          <label class="text-sm font-semibold mt-3" for="xuLy">X·ª≠ l√Ω</label>
          <input id="xuLy" type="text" class="w-full border rounded-lg p-3" placeholder="Tr·∫°ng th√°i x·ª≠ l√Ω" />

          <label class="text-sm font-semibold mt-3" for="file">Ch·ªçn file (·∫¢nh/Excel)</label>
          <input id="file" type="file" class="w-full border rounded-lg p-3"
                 accept=".png,.jpg,.jpeg,.webp,.pdf,.xlsx,.xls,.csv" />
        </div>

        <button
          onclick="submitData()"
          class="mt-6 inline-flex items-center gap-2 bg-emerald-600 text-white font-semibold rounded-lg px-5 py-3 hover:bg-emerald-700">
          üì§ Upload
        </button>
      </section>

      <!-- 2) T√åM KI·∫æM D·ªÆ LI·ªÜU -->
      <section class="glass soft-shadow rounded-2xl p-6 md:p-8 w-full">
        <h2 class="text-xl font-extrabold text-slate-800 flex items-center gap-2">
          üîé T√¨m ki·∫øm D·ªØ li·ªáu
        </h2>

        <div class="mt-6 grid grid-cols-1 gap-4">
          <label class="text-sm font-semibold" for="searchDaily">T√¨m theo ƒê·∫°i l√Ω</label>
          <input id="searchDaily" type="text" class="w-full border rounded-lg p-3" placeholder="Nh·∫≠p t·ª´ kh√≥a ƒë·∫°i l√Ω" />

          <label class="text-sm font-semibold" for="searchNoiDung">T√¨m theo N·ªôi dung</label>
          <input id="searchNoiDung" type="text" class="w-full border rounded-lg p-3" placeholder="Nh·∫≠p t·ª´ kh√≥a n·ªôi dung" />
        </div>

        <button id="btnSearch"
          onclick="searchData()"
          class="mt-6 inline-flex items-center gap-2 bg-sky-600 text-white font-semibold rounded-lg px-5 py-3 hover:bg-sky-700">
          üîç T√¨m ki·∫øm
        </button>

        <!-- K·∫øt qu·∫£ -->
        <div id="searchResults" class="mt-6 text-sm text-slate-700"></div>
      </section>

    </div>
  </main>

  <script>
    // ======= C·∫§U H√åNH CHUNG =======
    const WEB_APP_URL =
      "https://script.google.com/macros/s/AKfycbxhcotw2glL0CSKzm_AH51U1OUjP4v_a204djzCgCPpAdNa3VruXkMen-y9P2aL5aU/exec";

    // ======= UPLOAD / L∆ØU D·ªÆ LI·ªÜU =======
    async function submitData() {
      const daily     = document.getElementById("daily").value.trim();
      const noiDung   = document.getElementById("noiDung").value.trim();
      const employee  = document.getElementById("employee").value.trim();
      const xuLy      = document.getElementById("xuLy").value.trim();
      const fileInput = document.getElementById("file").files[0];

      if (!daily || !noiDung || !employee || !xuLy) {
        alert("‚ö†Ô∏è Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß: ƒê·∫°i l√Ω, N·ªôi dung, Nh√¢n vi√™n, X·ª≠ l√Ω.");
        return;
      }

      let fileData = "", fileName = "", mimeType = "";
      if (fileInput) {
        fileName = fileInput.name;
        mimeType = fileInput.type || "";
        const reader = new FileReader();
        fileData = await new Promise((resolve) => {
          reader.onload = (e) => resolve(String(e.target.result).split(",")[1]);
          reader.readAsDataURL(fileInput);
        });
      }

      try {
        const res = await fetch(WEB_APP_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ daily, noiDung, employee, xuLy, fileName, mimeType, base64: fileData })
        });
        const json = await res.json().catch(() => ({}));
        alert("‚úÖ ƒê√£ l∆∞u th√†nh c√¥ng!");
        console.log("Upload result:", json);

        // Clear form:
        document.getElementById("daily").value = "";
        document.getElementById("noiDung").value = "";
        document.getElementById("employee").value = "";
        document.getElementById("xuLy").value = "";
        document.getElementById("file").value = "";
      } catch (e) {
        console.error(e);
        alert("‚ùå L·ªói khi l∆∞u d·ªØ li·ªáu!");
      }
    }

    // ======= T√åM KI·∫æM D·ªÆ LI·ªÜU =======
    async function searchData() {
      const searchDaily   = document.getElementById("searchDaily").value.trim().toLowerCase();
      const searchNoiDung = document.getElementById("searchNoiDung").value.trim().toLowerCase();

      try {
        // Web App ph·∫£i h·ªó tr·ª£ tr·∫£ JSON khi g·ªçi GET
        const res = await fetch(WEB_APP_URL);
        const data = await res.json();

        // L·ªçc k·∫øt qu·∫£
        const results = (Array.isArray(data) ? data : []).filter(row =>
          (!searchDaily   || String(row.daily   || "").toLowerCase().includes(searchDaily)) &&
          (!searchNoiDung || String(row.noiDung || "").toLowerCase().includes(searchNoiDung))
        );

        // Hi·ªÉn th·ªã k·∫øt qu·∫£
        const box = document.getElementById("searchResults");
        if (!results.length) {
          box.innerHTML = "<p class='text-red-600'>‚ùå Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu ph√π h·ª£p</p>";
          return;
        }

        // D·∫°ng b·∫£ng cho d·ªÖ xem
        const rows = results.map(r => `
          <tr class="border-b">
            <td class="px-3 py-2">${escapeHTML(r.daily)}</td>
            <td class="px-3 py-2">${escapeHTML(r.noiDung)}</td>
            <td class="px-3 py-2">${escapeHTML(r.employee)}</td>
            <td class="px-3 py-2">${escapeHTML(r.xuLy)}</td>
          </tr>
        `).join("");

        box.innerHTML = `
          <div class="overflow-auto rounded-lg border">
            <table class="min-w-full text-left text-sm">
              <thead class="bg-slate-100 text-slate-700">
                <tr>
                  <th class="px-3 py-2">ƒê·∫°i l√Ω</th>
                  <th class="px-3 py-2">N·ªôi dung</th>
                  <th class="px-3 py-2">Nh√¢n vi√™n</th>
                  <th class="px-3 py-2">X·ª≠ l√Ω</th>
                </tr>
              </thead>
              <tbody>${rows}</tbody>
            </table>
          </div>`;
      } catch (e) {
        console.error(e);
        alert("‚ùå L·ªói l·∫•y d·ªØ li·ªáu t√¨m ki·∫øm!");
      }
    }

    // Helper an to√†n HTML
    function escapeHTML(s){
      return String(s ?? "").replace(/[&<>"']/g, c => ({
        "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
      }[c]));
    }
  </script>
</body>
</html>
