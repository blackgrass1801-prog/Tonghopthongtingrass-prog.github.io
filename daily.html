<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Nh·∫≠p & T√¨m ki·∫øm d·ªØ li·ªáu ƒê·∫°i l√Ω</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .glass{background:rgba(255,255,255,.92);backdrop-filter:blur(8px)}
    .soft-shadow{box-shadow:0 10px 25px rgba(0,0,0,.08)}
  </style>
</head>
<body class="min-h-screen bg-slate-50">
  <main class="w-full px-4 md:px-8 py-10">
    <div class="mx-auto w-full max-w-screen-lg space-y-10">

      <!-- 1) NH·∫¨P D·ªÆ LI·ªÜU ƒê·∫†I L√ù -->
      <section class="glass soft-shadow rounded-2xl p-6 md:p-8 w-full">
        <h1 class="text-4xl font-extrabold text-center mb-6" style="color:#00A3C6;">SHBET</h1>

        <h2 class="text-xl font-extrabold text-slate-800 flex items-center gap-2">üìå Nh·∫≠p d·ªØ li·ªáu ƒê·∫°i l√Ω</h2>

        <div class="mt-6 grid grid-cols-1 gap-4">
          <label class="text-sm font-semibold" for="daiLy">ƒê·∫°i l√Ω</label>
          <input id="daiLy" type="text" class="w-full border rounded-lg p-3" placeholder="Nh·∫≠p t√™n ƒë·∫°i l√Ω" />

          <label class="text-sm font-semibold mt-3" for="noiDung">N·ªôi dung</label>
          <textarea id="noiDung" rows="4" class="w-full border rounded-lg p-3" placeholder="Nh·∫≠p n·ªôi dung"></textarea>

          <label class="text-sm font-semibold mt-3" for="nhanVien">Nh√¢n vi√™n</label>
          <input id="nhanVien" type="text" class="w-full border rounded-lg p-3" placeholder="Nh·∫≠p t√™n nh√¢n vi√™n" />

          <label class="text-sm font-semibold mt-3" for="xuLy">X·ª≠ l√Ω</label>
          <select id="xuLy" class="w-full border rounded-lg p-3">
            <option value="">-- Ch·ªçn tr·∫°ng th√°i --</option>
            <option>ƒê√£ x·ª≠ l√Ω</option>
            <option>Ch∆∞a x·ª≠ l√Ω</option>
            <option>T·ªï tr∆∞·ªüng ch∆∞a ph·∫£n h·ªìi</option>
            <option>H·ªßy h·ª£p t√°c</option>
          </select>

          <label class="text-sm font-semibold mt-3" for="file">Ch·ªçn file (·∫¢nh/Excel/PDF)</label>
          <input id="file" type="file" class="w-full border rounded-lg p-3"
                 accept=".png,.jpg,.jpeg,.webp,.pdf,.xlsx,.xls,.csv" />

          <div id="filePreview" class="mt-2"></div>
        </div>

        <button id="btnUpload" onclick="submitData()" class="mt-6 inline-flex items-center gap-2 bg-emerald-600 text-white font-semibold rounded-lg px-5 py-3 hover:bg-emerald-700">
          üì§ Upload
        </button>
      </section>

      <!-- 2) T√åM KI·∫æM D·ªÆ LI·ªÜU -->
      <section class="glass soft-shadow rounded-2xl p-6 md:p-8 w-full">
        <h2 class="text-xl font-extrabold text-slate-800 flex items-center gap-2">üîé T√¨m ki·∫øm D·ªØ li·ªáu</h2>

        <div class="mt-6 grid grid-cols-1 gap-4">
          <label class="text-sm font-semibold" for="searchdaiLy">T√¨m theo ƒê·∫°i l√Ω</label>
          <input id="searchdaiLy" type="text" class="w-full border rounded-lg p-3" placeholder="Nh·∫≠p t·ª´ kh√≥a ƒë·∫°i l√Ω" />

          <label class="text-sm font-semibold" for="searchNoiDung">T√¨m theo N·ªôi dung</label>
          <input id="searchNoiDung" type="text" class="w-full border rounded-lg p-3" placeholder="Nh·∫≠p t·ª´ kh√≥a n·ªôi dung" />

          <label class="text-sm font-semibold" for="searchXuLy">T√¨m theo Tr·∫°ng th√°i x·ª≠ l√Ω</label>
          <select id="searchXuLy" class="w-full border rounded-lg p-3">
            <option value="--all--">-- T·∫•t c·∫£ --</option>
            <option value="ƒê√£ x·ª≠ l√Ω">ƒê√£ x·ª≠ l√Ω</option>
            <option value="Ch∆∞a x·ª≠ l√Ω">Ch∆∞a x·ª≠ l√Ω</option>
            <option value="T·ªï tr∆∞·ªüng ch∆∞a ph·∫£n h·ªìi">T·ªï tr∆∞·ªüng ch∆∞a ph·∫£n h·ªìi</option>
            <option value="H·ªßy h·ª£p t√°c">H·ªßy h·ª£p t√°c</option>
          </select>
        </div>

        <button id="btnSearch" onclick="searchData()" class="mt-6 inline-flex items-center gap-2 bg-sky-600 text-white font-semibold rounded-lg px-5 py-3 hover:bg-sky-700">
          üîç T√¨m ki·∫øm
        </button>

        <div id="searchResults" class="mt-6 text-sm text-slate-700"></div>
      </section>

    </div>
  </main>

  <script>
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxcQBiSmgrz3ldPZM-Bb-U31CQXEf4gKP4pnLXflxGASx4BUoqdZ7Tgc9qXlCxuzjO4/exec";

    /* ===== Helpers: Drive link -> viewable image ===== */
    function parseDriveId(url){
      const m = String(url||'').match(/\/file\/d\/([^/]+)\//);
      if (m && m[1]) return m[1];
      // th√™m tr∆∞·ªùng h·ª£p share link d·∫°ng open?id=
      const m2 = String(url||'').match(/[?&]id=([^&]+)/);
      return m2 ? m2[1] : '';
    }
    function toDriveViewUrl(url){
      const id = parseDriveId(url);
      return id ? `https://drive.google.com/uc?export=view&id=${id}` : url;
    }
    function isImageByExt(name=''){
      return /\.(png|jpe?g|webp|gif|bmp|svg)$/i.test(name);
    }

    /* ====== Preview file khi ch·ªçn ====== */
    document.getElementById('file').addEventListener('change', (e) => {
      const f = e.target.files?.[0];
      const box = document.getElementById('filePreview');
      if (!f) { box.innerHTML = ''; return; }

      const isImg = f.type.startsWith('image/') || isImageByExt(f.name);
      const size = formatFileSize(f.size);
      if (isImg) {
        const url = URL.createObjectURL(f);
        box.innerHTML = `
          <div class="flex items-center gap-3 p-3 bg-slate-50 rounded-lg border">
            <img src="${url}" alt="preview" class="h-16 w-16 object-cover rounded" />
            <div class="min-w-0">
              <div class="font-medium truncate">${escapeHTML(f.name)}</div>
              <div class="text-xs text-slate-500">${escapeHTML(f.type || 'image')}, ${size}</div>
            </div>
          </div>`;
      } else {
        box.innerHTML = `
          <div class="flex items-center gap-3 p-3 bg-slate-50 rounded-lg border">
            <div class="h-10 w-10 rounded bg-slate-200 flex items-center justify-center text-slate-700">üìé</div>
            <div class="min-w-0">
              <div class="font-medium truncate">${escapeHTML(f.name)}</div>
              <div class="text-xs text-slate-500">${escapeHTML(f.type || 'file')}, ${size}</div>
            </div>
          </div>`;
      }
    });

    /* ===== UPLOAD ===== */
    async function submitData() {
      const daiLy    = document.getElementById("daiLy").value.trim();
      const noiDung  = document.getElementById("noiDung").value.trim();
      const nhanVien = document.getElementById("nhanVien").value.trim();
      const xuLy     = document.getElementById("xuLy").value.trim();
      const fileInput= document.getElementById("file").files[0];

      if (!daiLy || !noiDung || !nhanVien || !xuLy) {
        alert("‚ö†Ô∏è Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß: ƒê·∫°i l√Ω, N·ªôi dung, Nh√¢n vi√™n, X·ª≠ l√Ω.");
        return;
      }

      const btn = document.getElementById("btnUpload");
      btn.disabled = true; btn.textContent = "ƒêang g·ª≠i...";

      let fileData = "", fileName = "", mimeType = "", fileSize = 0;
      if (fileInput) {
        fileName = fileInput.name;
        mimeType = fileInput.type || "";
        fileSize = fileInput.size || 0;
        const reader = new FileReader();
        fileData = await new Promise((resolve) => {
          reader.onload = (e) => resolve(String(e.target.result).split(",")[1]);
          reader.readAsDataURL(fileInput);
        });
      }

      const timeSent = new Date().toISOString();

      try {
        const res = await fetch(WEB_APP_URL, {
          method: "POST",
          body: JSON.stringify({
            daiLy, noiDung, nhanVien, xuLy,
            fileName, mimeType, base64: fileData, fileSize,
            timeSent
          })
        });
        if (!res.ok) throw new Error("HTTP " + res.status);
        const json = await res.json().catch(() => ({}));
        if (!json.ok) throw new Error(json.error || "Upload th·∫•t b·∫°i");
        alert("‚úÖ ƒê√£ l∆∞u th√†nh c√¥ng!");
        document.getElementById("daiLy").value = "";
        document.getElementById("noiDung").value = "";
        document.getElementById("nhanVien").value = "";
        document.getElementById("xuLy").value = "";
        document.getElementById("file").value = "";
        document.getElementById("filePreview").innerHTML = "";
      } catch (e) {
        console.error(e);
        alert("‚ùå L·ªói khi l∆∞u d·ªØ li·ªáu!");
      } finally {
        btn.disabled = false; btn.textContent = "üì§ Upload";
      }
    }

    /* ===== T√åM KI·∫æM ===== */
    async function searchData() {
      const kwDaily   = document.getElementById("searchdaiLy").value.trim().toLowerCase();
      const kwNoiDung = document.getElementById("searchNoiDung").value.trim().toLowerCase();
      const pickXuLy  = document.getElementById("searchXuLy").value;

      const box = document.getElementById("searchResults");
      box.innerHTML = "<p class='text-slate-500'>ƒêang t·∫£i d·ªØ li·ªáu...</p>";

      try {
        const res = await fetch(WEB_APP_URL + "?action=list", { method: "GET", cache: "no-store" });
        if (!res.ok) throw new Error("HTTP " + res.status);
        const json = await res.json();
        if (!json.ok) throw new Error(json.error || "Response not ok");

        const rows = Array.isArray(json.rows) ? json.rows : [];

        const filtered = rows.filter(r => {
          const daily   = String(r.daily   || r.daiLy   || "").toLowerCase();
          const content = String(r.noiDung || "").toLowerCase();
          const xl      = String(r.xuLy    || "");
          const passDaily   = !kwDaily   || daily.includes(kwDaily);
          const passNoiDung = !kwNoiDung || content.includes(kwNoiDung);
          const passXuLy    = (pickXuLy === "--all--" || pickXuLy === "" || xl === pickXuLy);
          return passDaily && passNoiDung && passXuLy;
        });

        if (!filtered.length) {
          box.innerHTML = "<p class='text-red-600'>‚ùå Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu ph√π h·ª£p</p>";
          return;
        }

        const htmlRows = filtered.map(r => renderRow(r)).join("");

        box.innerHTML = `
          <div class="overflow-auto rounded-lg border">
            <table class="min-w-full text-left text-sm">
              <thead class="bg-slate-100 text-slate-700">
                <tr>
                  <th class="px-3 py-2">ƒê·∫°i l√Ω</th>
                  <th class="px-3 py-2">N·ªôi dung</th>
                  <th class="px-3 py-2">Nh√¢n vi√™n</th>
                  <th class="px-3 py-2">Tr·∫°ng th√°i x·ª≠ l√Ω</th>
                  <th class="px-3 py-2">T·ªáp ƒë√≠nh k√®m</th>
                  <th class="px-3 py-2">Th·ªùi gian</th>
                </tr>
              </thead>
              <tbody>${htmlRows}</tbody>
            </table>
          </div>`;
      } catch (e) {
        console.error("searchData error:", e);
        alert("‚ùå L·ªói l·∫•y d·ªØ li·ªáu t√¨m ki·∫øm!");
        box.innerHTML = "";
      }
    }

    function renderRow(r){
      const daily   = escapeHTML(r.daily ?? r.daiLy ?? '');
      const noiDung = escapeHTML(r.noiDung ?? '');
      const nhanVien= escapeHTML(r.nhanVien ?? r.employee ?? '');
      const xuLy    = escapeHTML(r.xuLy ?? '');

      const fileUrl   = r.thumbUrl || r.fileUrl || r.url || r.link || '';
      const fileName  = r.fileName || r.filename || '';
      const mimeType  = r.mimeType || r.mimetype || '';
      const base64    = r.base64 || '';
      const timeIso   = r.timeSent || r.timestamp || r.time || '';

      const attachCell = renderAttachment({fileUrl, fileName, mimeType, base64});
      const timeCell   = formatTimeVN(timeIso);

      return `
        <tr class="border-b align-top">
          <td class="px-3 py-2">${daily}</td>
          <td class="px-3 py-2">${noiDung}</td>
          <td class="px-3 py-2">${nhanVien}</td>
          <td class="px-3 py-2">${xuLy}</td>
          <td class="px-3 py-2">${attachCell}</td>
          <td class="px-3 py-2 whitespace-nowrap">${timeCell}</td>
        </tr>`;
    }

    function renderAttachment({fileUrl, fileName, mimeType, base64}){
      let url = '';
      let openUrl = '';

      if (fileUrl) {
        // n·∫øu l√† link Drive /file/d/... ‚Üí ƒë·ªïi sang uc?export=view ƒë·ªÉ hi·ªÉn th·ªã
        url = toDriveViewUrl(fileUrl);
        openUrl = fileUrl;
      } else if (base64 && (mimeType||'').startsWith('image/')) {
        url = `data:${mimeType};base64,${base64}`;
        openUrl = url;
      }

      const safeName = escapeHTML(fileName || (mimeType ? `T·ªáp (${mimeType})` : 'T·ªáp ƒë√≠nh k√®m'));

      const looksImage = (mimeType||'').startsWith('image/') || isImageByExt(fileName) || (url && url.startsWith('data:image'));
      if (url && looksImage) {
        return `
          <div class="flex items-center gap-3">
            <a href="${openUrl || url}" target="_blank" class="block">
              <img src="${url}" alt="img" class="h-12 w-12 rounded object-cover border" />
            </a>
            <a href="${openUrl || url}" target="_blank" class="text-sky-700 hover:underline truncate max-w-[220px]">${safeName}</a>
          </div>`;
      }

      if (openUrl || url) {
        return `<a href="${openUrl || url}" target="_blank" class="inline-flex items-center gap-2 px-2 py-1 rounded bg-slate-100 border text-slate-700">üìé <span class="truncate max-w-[240px]">${safeName}</span></a>`;
      }
      if (fileName) {
        return `<span class="inline-flex items-center gap-2 px-2 py-1 rounded bg-slate-100 border text-slate-600">üìé <span class="truncate max-w-[240px]">${safeName}</span></span>`;
      }
      return '<span class="text-slate-400">‚Äî</span>';
    }

    function escapeHTML(s){
      return String(s ?? "").replace(/[&<>\"']/g, c => ({
        "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
      }[c]));
    }

    function formatTimeVN(iso){
      if (!iso) return '<span class="text-slate-400">‚Äî</span>';
      const d = new Date(iso);
      if (isNaN(d.getTime())) return escapeHTML(String(iso));
      try {
        return new Intl.DateTimeFormat('vi-VN', {
          timeZone: 'Asia/Phnom_Penh',
          day: '2-digit', month: '2-digit', year: 'numeric',
          hour: '2-digit', minute: '2-digit', hour12: false
        }).format(d);
      } catch {
        return d.toLocaleString('vi-VN');
      }
    }

    function formatFileSize(bytes){
      if (!bytes && bytes !== 0) return '';
      const thresh = 1024;
      if (Math.abs(bytes) < thresh) return bytes + ' B';
      const units = ['KB','MB','GB','TB'];
      let u = -1; let b = bytes;
      do { b /= thresh; ++u; } while (Math.abs(b) >= thresh && u < units.length - 1);
      return b.toFixed(1) + ' ' + units[u];
    }
  </script>
</body>
</html>
